# Wi-Fi Nomads Cache Control Configuration
# Complete cache-busting solution for immediate updates

# Enable mod_expires and mod_headers
<IfModule mod_expires.c>
    ExpiresActive on
</IfModule>

<IfModule mod_headers.c>
    # Remove ETags to prevent conditional requests
    Header unset ETag
    FileETag None
    
    # Global cache-control headers
    Header set Cache-Control "no-cache, no-store, must-revalidate"
    Header set Pragma "no-cache"
    Header set Expires "0"
</IfModule>

# HTML files - Never cache
<FilesMatch "\.(html|htm|php)$">
    <IfModule mod_expires.c>
        ExpiresDefault "access plus 0 seconds"
    </IfModule>
    <IfModule mod_headers.c>
        Header set Cache-Control "no-cache, no-store, must-revalidate, max-age=0"
        Header set Pragma "no-cache"
        Header set Expires "0"
        Header set X-Cache-Control "no-cache"
    </IfModule>
</FilesMatch>

# CSS files - Short cache with versioning support
<FilesMatch "\.(css)$">
    <IfModule mod_expires.c>
        ExpiresDefault "access plus 1 hour"
    </IfModule>
    <IfModule mod_headers.c>
        Header set Cache-Control "public, max-age=3600, must-revalidate"
        # But if versioned, allow longer caching
        Header set Cache-Control "public, max-age=86400" "expr=%{QUERY_STRING} =~ /v=/"
    </IfModule>
</FilesMatch>

# JavaScript files - Short cache with versioning support  
<FilesMatch "\.(js)$">
    <IfModule mod_expires.c>
        ExpiresDefault "access plus 1 hour"
    </IfModule>
    <IfModule mod_headers.c>
        Header set Cache-Control "public, max-age=3600, must-revalidate"
        # But if versioned, allow longer caching
        Header set Cache-Control "public, max-age=86400" "expr=%{QUERY_STRING} =~ /v=/"
    </IfModule>
</FilesMatch>

# Image files - Moderate caching (they change less frequently)
<FilesMatch "\.(jpg|jpeg|png|gif|webp|svg|ico)$">
    <IfModule mod_expires.c>
        ExpiresDefault "access plus 7 days"
    </IfModule>
    <IfModule mod_headers.c>
        Header set Cache-Control "public, max-age=604800"
    </IfModule>
</FilesMatch>

# Font files - Long term caching
<FilesMatch "\.(woff|woff2|ttf|eot)$">
    <IfModule mod_expires.c>
        ExpiresDefault "access plus 30 days"
    </IfModule>
    <IfModule mod_headers.c>
        Header set Cache-Control "public, max-age=2592000"
    </IfModule>
</FilesMatch>

# JSON and XML files - No caching
<FilesMatch "\.(json|xml)$">
    <IfModule mod_headers.c>
        Header set Cache-Control "no-cache, no-store, must-revalidate"
        Header set Pragma "no-cache"
        Header set Expires "0"
    </IfModule>
</FilesMatch>

# Enable GZIP compression for better performance
<IfModule mod_deflate.c>
    AddOutputFilterByType DEFLATE text/plain
    AddOutputFilterByType DEFLATE text/html
    AddOutputFilterByType DEFLATE text/xml
    AddOutputFilterByType DEFLATE text/css
    AddOutputFilterByType DEFLATE application/xml
    AddOutputFilterByType DEFLATE application/xhtml+xml
    AddOutputFilterByType DEFLATE application/rss+xml
    AddOutputFilterByType DEFLATE application/javascript
    AddOutputFilterByType DEFLATE application/x-javascript
</IfModule>

# Security headers
<IfModule mod_headers.c>
    Header always set X-Content-Type-Options nosniff
    Header always set X-Frame-Options DENY
    Header always set X-XSS-Protection "1; mode=block"
    Header always set Referrer-Policy "strict-origin-when-cross-origin"
</IfModule>

# Force HTTPS redirect (uncomment if using HTTPS)
# RewriteEngine On
# RewriteCond %{HTTPS} off
# RewriteRule ^(.*)$ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]

# Browser-specific cache control for development
<IfModule mod_setenvif.c>
    # Detect if it's a development request
    SetEnvIfNoCase User-Agent ".*Chrome.*" chrome
    SetEnvIfNoCase User-Agent ".*Firefox.*" firefox
    SetEnvIfNoCase User-Agent ".*Safari.*" safari
    
    # Additional no-cache headers for development
    Header set X-Development-Mode "active" env=chrome
    Header set Cache-Control "no-cache, no-store, must-revalidate, private" env=chrome
</IfModule>

# Prevent caching of specific development files
<FilesMatch "(\.htaccess|\.git|\.env|package\.json|README\.md)">
    Order allow,deny
    Deny from all
</FilesMatch>
